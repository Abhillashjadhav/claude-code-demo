<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NASDAQ Tech Screener</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header>
    <h1>NASDAQ Tech Valuation Screener</h1>
    <p class="sub">Filter by valuation & sentiment. Click a row for details. Large-universe paging enabled.</p>
  </header>

  <section class="card">
    <form id="filters">
      <label>P/E max <input id="pe_max" type="number" step="0.1" placeholder="e.g. 25" /></label>
      <label>P/S max <input id="ps_max" type="number" step="0.1" placeholder="e.g. 8" /></label>
      <label>Sentiment min <input id="sentiment_min" type="number" step="0.01" placeholder="0.6" /></label>

      <label>Sort by
        <select id="sort_by">
          <option value="ticker">Ticker</option>
          <option value="pe">P/E</option>
          <option value="ps">P/S</option>
          <option value="sentiment">Sentiment</option>
        </select>
      </label>
      <label>Dir
        <select id="sort_dir">
          <option value="asc">Asc</option>
          <option value="desc">Desc</option>
        </select>
      </label>

      <label>Page size
        <select id="page_size">
          <option>25</option>
          <option selected>50</option>
          <option>100</option>
          <option>150</option>
          <option>200</option>
        </select>
      </label>

      <button type="submit">Run Screener</button>
      <button type="button" id="reset">Reset</button>
    </form>
  </section>

  <section class="card">
    <div class="pager">
      <button id="prev">◀ Prev</button>
      <span id="page_info">Page 1 / 1 (0)</span>
      <button id="next">Next ▶</button>
    </div>
    <div class="table-wrap">
      <table id="results">
        <thead>
          <tr>
            <th>Ticker</th><th>Name</th><th>P/E</th><th>P/S</th><th>Sentiment</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card" id="detail" hidden>
    <h2 id="d_title">Details</h2>
    <pre id="d_json" class="code"></pre>
  </section>

  <footer>
    <a href="/health" target="_blank">/health</a>
  </footer>

  <script>
    const state = { page: 1, page_size: 50, rows: [], total: 0, total_pages: 1 };
    const tbody = document.querySelector('#results tbody');
    const pageInfo = document.getElementById('page_info');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const detail = document.getElementById('detail');
    const dTitle = document.getElementById('d_title');
    const dJson = document.getElementById('d_json');

    function getParams() {
      const pe = document.getElementById('pe_max').value;
      const ps = document.getElementById('ps_max').value;
      const s  = document.getElementById('sentiment_min').value;
      const sort_by  = document.getElementById('sort_by').value;
      const sort_dir = document.getElementById('sort_dir').value;
      const page_size = parseInt(document.getElementById('page_size').value, 10) || 50;
      return { pe_max: pe, ps_max: ps, sentiment_min: s, sort_by, sort_dir, page_size };
    }

    async function loadPage(page=1) {
      const p = getParams();
      p.page = page;
      const qs = new URLSearchParams(Object.entries(p).filter(([,v]) => v !== '' && v != null));
      const res = await fetch(`/screener?${qs.toString()}`);
      const json = await res.json();
      state.page = json.page;
      state.page_size = json.page_size;
      state.rows = json.items || [];
      state.total = json.total || 0;
      state.total_pages = json.total_pages || 1;
      render();
    }

    function render() {
      tbody.innerHTML = '';
      for (const r of state.rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-key="ticker">${r.ticker ?? ''}</td>
          <td>${r.name ?? ''}</td>
          <td>${r.pe ?? ''}</td>
          <td>${r.ps ?? ''}</td>
          <td>${r.sentiment ?? ''}</td>
        `;
        tr.addEventListener('click', async () => {
          const t = tr.querySelector('[data-key="ticker"]').textContent.trim();
          const res = await fetch(`/stocks/${encodeURIComponent(t)}`);
          if (res.ok) {
            const data = await res.json();
            dTitle.textContent = `Details — ${t}`;
            dJson.textContent = JSON.stringify(data, null, 2);
            detail.hidden = false;
            window.scrollTo({ top: detail.offsetTop - 10, behavior: 'smooth' });
          }
        });
        tbody.appendChild(tr);
      }
      pageInfo.textContent = `Page ${state.page} / ${state.total_pages} (${state.total})`;
      prevBtn.disabled = state.page <= 1;
      nextBtn.disabled = state.page >= state.total_pages;
    }

    prevBtn.onclick = () => { if (state.page > 1) loadPage(state.page - 1); };
    nextBtn.onclick = () => { if (state.page < state.total_pages) loadPage(state.page + 1); };

    document.getElementById('filters').addEventListener('submit', (e) => {
      e.preventDefault();
      loadPage(1);
    });
    document.getElementById('reset').addEventListener('click', () => {
      for (const id of ['pe_max','ps_max','sentiment_min']) document.getElementById(id).value='';
      document.getElementById('sort_by').value='ticker';
      document.getElementById('sort_dir').value='asc';
      loadPage(1);
    });

    // initial load
    loadPage(1);
  </script>
</body>
</html>
